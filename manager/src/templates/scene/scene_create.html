<!--
SPDX-FileCopyrightText: (C) 2025 Intel Corporation
SPDX-License-Identifier: Apache-2.0
-->

{% extends 'sscape/base.html' %}
{% load static %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/geospatial.css' %}" />
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="/">Scenes</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">New Scene</li>
    </ol>
  </nav>

  <div id="createSceneForm" class="card width-100">
    <h5 class="noselect card-header">New Scene</h5>
    <div class="card-body">
      <form enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <!-- Name field - always visible -->
        {% for field in form %}
          {% if field.name == 'name' %}
            <div class="form-group row" id="{{ field.name }}_wrapper">
              <label
                class="col-sm-2 col-form-label"
                id="label_{{ field.name }}"
                for="id_{{ field.name }}"
                >{{ field.label }}</label
              >
              <div class="col-sm-10">
                {{ field.errors }}
                {{ field }}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <!-- Map Type field - connected to Django form -->
        {% for field in form %}
          {% if field.name == 'map_type' %}
            <div class="form-group row" id="{{ field.name }}_wrapper">
              <label
                class="col-sm-2 col-form-label"
                id="label_{{ field.name }}"
                for="id_{{ field.name }}"
                >{{ field.label }}</label
              >
              <div class="col-sm-10">
                {{ field.errors }}
                <select
                  id="id_{{ field.name }}"
                  name="{{ field.name }}"
                  class="form-control"
                >
                  <option
                    value="map_upload"
                    {% if field.value == 'map_upload' %}selected{% endif %}
                  >
                    Upload Map
                  </option>
                  <option
                    value="geospatial_map"
                    {% if field.value == 'geospatial_map' %}selected{% endif %}
                  >
                    Geospatial Map
                  </option>
                </select>
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <!-- Upload-specific fields -->
        <div id="uploadFields">
          {% for field in form %}
            {% if field.name == 'map' %}
              <div class="form-group row" id="{{ field.name }}_wrapper">
                <label
                  class="col-sm-2 col-form-label"
                  id="label_{{ field.name }}"
                  for="id_{{ field.name }}"
                  >{{ field.label }}</label
                >
                <div class="col-sm-10">
                  {{ field.errors }}
                  {{ field }}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <!-- Scale field - always visible -->
        {% for field in form %}
          {% if field.name == 'scale' %}
            <div class="form-group row" id="scale_wrapper">
              <label
                class="col-sm-2 col-form-label"
                id="label_{{ field.name }}"
                for="id_{{ field.name }}"
                >{{ field.label }}</label
              >
              <div class="col-sm-10">
                {{ field.errors }}
                {{ field }}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <div id="geospatialFields" style="display:none;">
          <!-- Geospatial Map Body Start -->
          <div class="form-group row">
            <label class="col-sm-2 col-form-label" for="mapProvider"
              >Map Provider</label
            >
            <div class="col-sm-10">
              <select id="mapProvider" class="form-control">
                <option value="google">Google Maps</option>
                <option value="mapbox">Mapbox</option>
              </select>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label" for="locationInput"
              >Location</label
            >
            <div class="col-sm-10">
              <div class="input-group">
                <input
                  type="text"
                  id="locationInput"
                  class="form-control"
                  placeholder="Enter coordinates (lat,lng) or address"
                />
                <div class="input-group-append">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-action="moveToLocation"
                  >
                    Go
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"></div>
            <div class="col-sm-10">
              <button
                type="button"
                class="btn btn-primary"
                data-action="generateBounds"
              >
                Generate Geospatial Bounds & Snapshot
              </button>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Map</label>
            <div class="col-sm-10">
              <div id="map"></div>
            </div>
          </div>
          <!-- Geospatial-specific fields -->
          {% for field in form %}
            {% if field.name == 'output_lla' %}
              <div class="form-group row" id="{{ field.name }}_wrapper">
                <label
                  class="col-sm-2 col-form-label"
                  id="label_{{ field.name }}"
                  for="id_{{ field.name }}"
                  >{{ field.label }}</label
                >
                <div class="col-sm-10">
                  {{ field.errors }}
                  {{ field }}
                </div>
              </div>
            {% endif %}
          {% endfor %}
          {% for field in form %}
            {% if field.name == 'map_corners_lla' %}
              <div class="form-group row" id="{{ field.name }}_wrapper">
                <label
                  class="col-sm-2 col-form-label"
                  id="label_{{ field.name }}"
                  for="id_{{ field.name }}"
                  >{{ field.label }}</label
                >
                <div class="col-sm-10">
                  {{ field.errors }}
                  {{ field }}
                  <small class="form-text text-muted"
                    >{{ field.help_text }}</small
                  >
                </div>
              </div>
            {% endif %}
          {% endfor %}

          <!-- Hidden fields for geospatial map settings -->
          {% for field in form %}
            {% if field.name in 'geospatial_provider,map_zoom,map_center_lat,map_center_lng,map_bearing' %}
              {{ field.as_hidden }}
            {% endif %}
          {% endfor %}
          <div
            id="screenshotMsg"
            style="display:none; color: red; font-weight: bold; margin: 10px 0;"
          ></div>
          <img id="snapshot" alt="Map Snapshot" style="display:none;" />
          <canvas
            id="stitchedSnapshot"
            width="1280"
            height="1280"
            style="display:none;"
          ></canvas>
          <!-- Geospatial Map Body End -->
        </div>

        <div class="form-group row" id="save_scene_create">
          <div class="col-sm-2"></div>
          <div class="col-sm-10">
            <input
              class="btn btn-primary"
              id="save"
              type="submit"
              value="Save New Scene"
            />
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- API Keys from environment variables (CSP-compliant using json_script) -->
  {{ google_maps_api_key|json_script:"google-maps-api-key" }}
  {{ mapbox_api_key|json_script:"mapbox-api-key" }}
  <script src="/static/js/geospatial/map-interface.js"></script>
  <script src="/static/js/geospatial/google-maps-plugin.js"></script>
  <script src="/static/js/geospatial/mapbox-plugin.js"></script>
  <script src="/static/js/geospatial/geomanager.js"></script>
  <script src="/static/js/geospatial/scene-form.js"></script>
{% endblock %}
